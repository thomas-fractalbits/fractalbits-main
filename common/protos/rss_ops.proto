syntax = "proto3";

package rss_ops;

import "google/protobuf/empty.proto";

enum Command {
  Invalid = 0;
  Handshake = 1;

  Put = 16;
  Get = 17;
  Delete = 18;
  List = 19;

  // NSS role management
  GetNssRole = 21;

  // AZ status management
  GetAzStatus = 22;
  SetAzStatus = 23;

  // Bucket management
  CreateBucket = 24;
  DeleteBucket = 25;

  // Data Volume Group management
  GetDataVgInfo = 26;

  // Metadata Volume Group management
  GetMetadataVgInfo = 27;
}

// Put
message PutRequest {
  int64 version = 1;
  string key = 2;
  string value = 3;
}

message PutResponse {
  oneof result {
    google.protobuf.Empty ok = 1;
    google.protobuf.Empty err_retry = 2;
    string err_other = 3;
  }
}


// Get
message GetRequest {
  string key = 1;
}

message GetResponse {
  oneof result {
    ValueWithVersion ok = 1;
    google.protobuf.Empty err_not_found = 2;
    string err_other = 3;
  }
}

message ValueWithVersion {
  int64 version = 1;
  string value = 2;
}

// Delete
message DeleteRequest {
  string key = 1;
}

message DeleteResponse {
  oneof result {
    google.protobuf.Empty ok = 1;
    string err = 2;
  }
}


// List
message ListRequest {
  string prefix = 1;
}

message ListResponse {
  oneof result {
    ListKeyValues ok = 1;
    string err = 2;
  }
}

message ListKeyValues {
  repeated string kvs = 3;
}

// GetNssRole - Query NSS instance role from service-discovery table
message GetNssRoleRequest {
  string instance_id = 1;  // "nss-A" or "nss-B"
  optional NssAgentHealthReport health_report = 2;  // Agent reports its managed service health
}

// Health report pushed by nss_role_agent when calling GetNssRole
message NssAgentHealthReport {
  string service_type = 1;    // "nss" or "mirrord"
  string status = 2;          // "active", "solo", "standby", "degraded", "failure"
  bool is_running = 3;
  uint64 timestamp_ms = 4;    // When health was last checked
}

message GetNssRoleResponse {
  oneof result {
    string role = 1;  // "active", "standby", "solo", or "degraded"
    string error = 2;
  }
}

// GetAzStatus - Query AZ availability status from service-discovery table
message GetAzStatusResponse {
  oneof result {
    AzStatusMap status_map = 1;
    string error = 2;
  }
}

message AzStatusMap {
  map<string, string> az_status = 1;  // Key: AZ name (e.g. "use1-az4"), Value: status ("Normal", "Degraded", "Resync", "Sanitize")
}

// SetAzStatus - Update AZ availability status in service-discovery table
message SetAzStatusRequest {
  string az_id = 1;   // AZ name (e.g. "use1-az4")
  string status = 2;  // Status ("Normal", "Degraded", "Resync", "Sanitize")
}

message SetAzStatusResponse {
  oneof result {
    google.protobuf.Empty ok = 1;
    string error = 2;
  }
}

// CreateBucket - Create a new bucket with full NSS integration
message CreateBucketRequest {
  string bucket_name = 1;
  bool enable_versioning = 2;
  string api_key_id = 3;
  bool is_multi_az = 4;
}

message CreateBucketResponse {
  oneof result {
    google.protobuf.Empty ok = 1;
    google.protobuf.Empty err_bucket_already_exists = 2;
    google.protobuf.Empty err_bucket_already_owned_by_you = 3;
    string err_other = 4;
  }
}

// DeleteBucket - Delete an existing bucket with NSS integration
message DeleteBucketRequest {
  string bucket_name = 1;
  string api_key_id = 2;
}

message DeleteBucketResponse {
  oneof result {
    google.protobuf.Empty ok = 1;
    string error = 2;
  }
}

// GetDataVgInfo - Get data volume group configuration
message GetDataVgInfoRequest {
  // Empty for now - could add parameters later
}

message GetDataVgInfoResponse {
  oneof result {
    string info_json = 1;
    string error = 2;
  }
}

// GetMetadataVgInfo - Get metadata volume group configuration
message GetMetadataVgInfoRequest {
  // Empty for now - could add parameters later
}

message GetMetadataVgInfoResponse {
  oneof result {
    string info_json = 1;
    string error = 2;
  }
}
