#!/bin/bash

# Bash completion for cargo xtask with descriptions

_cargo_xtask_completion() {
    local cur prev words cword
    _init_completion || return

    # Find where 'xtask' appears in the command
    local xtask_index=-1
    for ((i=0; i<cword; i++)); do
        if [[ "${words[i]}" == "xtask" ]]; then
            xtask_index=$i
            break
        fi
    done

    # If xtask not found, return
    if [[ $xtask_index -eq -1 ]]; then
        return
    fi

    # Calculate position relative to xtask
    local position=$((cword - xtask_index))

    case $position in
        1)
            # First argument after xtask - show main commands with descriptions
            local help_output=$(cargo xtask --help 2>/dev/null)
            local commands_raw=$(echo "$help_output" | awk '/^Commands:/{flag=1; next} /^Options:/{flag=0} flag && /^  [a-z]/')

            if [[ -n "$commands_raw" ]]; then
                local matches=()

                while IFS= read -r line; do
                    if [[ "$line" =~ ^[[:space:]]+([a-z-]+)[[:space:]]+(.*) ]]; then
                        local cmd="${BASH_REMATCH[1]}"
                        local desc="${BASH_REMATCH[2]}"

                        if [[ "$cmd" == "$cur"* ]]; then
                            matches+=("$cmd")
                        fi
                    fi
                done <<< "$commands_raw"

                # Show descriptions when tab is pressed with empty current word
                if [[ -z "$cur" ]] && [[ ${#matches[@]} -gt 0 ]]; then
                    printf '\nAvailable xtask commands:\n' >&2
                    while IFS= read -r line; do
                        if [[ "$line" =~ ^[[:space:]]+([a-z-]+)[[:space:]]+(.*) ]]; then
                            printf '  %-15s -- %s\n' "${BASH_REMATCH[1]}" "${BASH_REMATCH[2]}" >&2
                        fi
                    done <<< "$commands_raw"
                    printf '\n' >&2
                fi

                COMPREPLY=("${matches[@]}")
            fi
            ;;
        2)
            # Second argument after xtask - show subcommands with descriptions if available
            local main_cmd="${words[$((xtask_index + 1))]}"

            if [[ -n "$main_cmd" ]]; then
                local help_output=$(cargo xtask "$main_cmd" --help 2>/dev/null)

                # Check if it has subcommands
                if echo "$help_output" | grep -q "^Commands:"; then
                    local subcommands_raw=$(echo "$help_output" | awk '/^Commands:/{flag=1; next} /^Options:/{flag=0} flag && /^  [a-z]/')

                    if [[ -n "$subcommands_raw" ]]; then
                        local matches=()

                        while IFS= read -r line; do
                            if [[ "$line" =~ ^[[:space:]]+([a-z-]+)[[:space:]]+(.*) ]]; then
                                local cmd="${BASH_REMATCH[1]}"
                                local desc="${BASH_REMATCH[2]}"

                                if [[ "$cmd" == "$cur"* ]]; then
                                    matches+=("$cmd")
                                fi
                            fi
                        done <<< "$subcommands_raw"

                        # Show descriptions when tab is pressed with empty current word
                        if [[ -z "$cur" ]] && [[ ${#matches[@]} -gt 0 ]]; then
                            printf '\nAvailable %s subcommands:\n' "$main_cmd" >&2
                            while IFS= read -r line; do
                                if [[ "$line" =~ ^[[:space:]]+([a-z-]+)[[:space:]]+(.*) ]]; then
                                    printf '  %-15s -- %s\n' "${BASH_REMATCH[1]}" "${BASH_REMATCH[2]}" >&2
                                fi
                            done <<< "$subcommands_raw"
                            printf '\n' >&2
                        fi

                        COMPREPLY=("${matches[@]}")
                        return
                    fi
                fi
            fi

            # Fall back to file completion
            _filedir
            ;;
        *)
            # Default file completion
            _filedir
            ;;
    esac
}

# Hook into cargo's completion for xtask subcommand
_cargo_completion_with_xtask() {
    # Check if this is a cargo xtask command
    if [[ "${COMP_WORDS[1]}" == "xtask" ]] || ([[ $COMP_CWORD -gt 1 ]] && [[ "${COMP_WORDS[1]}" == "xtask" ]]); then
        _cargo_xtask_completion
    else
        # Try to use existing cargo completion if available
        if declare -F _cargo &>/dev/null; then
            _cargo
        else
            # Basic cargo completion fallback
            local cur="${COMP_WORDS[COMP_CWORD]}"
            if [[ $COMP_CWORD -eq 1 ]]; then
                COMPREPLY=($(compgen -W "build check clean doc test bench update search publish install xtask" -- "$cur"))
            fi
        fi
    fi
}

complete -F _cargo_completion_with_xtask cargo