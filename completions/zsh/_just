#compdef just

# Dynamic completion for just with cargo xtask subcommands and descriptions

_just_custom() {
    local -a recipes

    # Get just recipes (space-separated)
    recipes=(${=$(just --summary 2>/dev/null)})

    # Check what we're completing
    if [[ ${#words[@]} -eq 2 ]]; then
        # Completing the recipe name (just <tab>)
        _describe 'recipe' recipes
    elif [[ ${#words[@]} -eq 3 ]]; then
        # Try to get subcommands dynamically from cargo xtask
        local recipe="${words[2]}"
        local -a subcommands_with_desc

        # Check if this recipe maps to a cargo xtask command
        case "$recipe" in
            build|service|precheckin|deploy|describe-stack|dump-vg-config|repo|git)
                # Try to get help output and parse subcommands with descriptions
                local help_output
                help_output=$(cargo xtask "$recipe" --help 2>/dev/null)

                # Check if it has subcommands by looking for "Commands:" section
                if echo "$help_output" | grep -q "^Commands:"; then
                    # Extract subcommands with descriptions
                    # Format: "command:description"
                    while IFS= read -r line; do
                        if [[ "$line" =~ ^[[:space:]]+([a-z-]+)[[:space:]]+(.*) ]]; then
                            local cmd="${match[1]}"
                            local desc="${match[2]}"
                            subcommands_with_desc+=("${cmd}:${desc}")
                        fi
                    done < <(echo "$help_output" | awk '/^Commands:/{flag=1; next} /^Options:/{flag=0} flag && /^  [a-z]/')

                    if [[ ${#subcommands_with_desc[@]} -gt 0 ]]; then
                        _describe -t subcommands "$recipe subcommand" subcommands_with_desc
                        return
                    fi
                fi
                ;;
        esac

        # Default to file completion if no subcommands found
        _files
    else
        # Default to file completion for additional arguments
        _files
    fi
}

# Register the completion function
_just_custom "$@"